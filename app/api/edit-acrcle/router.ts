import { NextResponse } from 'next/server';
import { cookies } from 'next/headers'; // <-- Import cookies à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸Šà¹‡à¸„à¸ªà¸´à¸—à¸˜à¸´à¹Œ
import prisma from '../../../lib/prisma'; // <-- à¹à¸à¹‰ path à¹„à¸›à¸¢à¸±à¸‡ prisma client à¸‚à¸­à¸‡à¹€à¸£à¸²

// à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™ GET à¸™à¸µà¹‰à¸ˆà¸°à¸—à¸³à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™ "à¸¢à¸²à¸¡" à¸‚à¸­à¸‡à¹€à¸£à¸²
export async function GET(
  request: Request,
  { params }: { params: { id: string } }
) {
  try {
    const {id} =  await params
    const articleId = Number(id);

    console.log('asfas', articleId)
    
    if (isNaN(articleId)) {
      return NextResponse.json({ error: "ID à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡" }, { status: 400 }); // 400 = Bad Request
    }

    // --- à¸™à¸µà¹ˆà¸„à¸·à¸­ Logic à¸ˆà¸²à¸ "à¸™à¸±à¸à¸ªà¸·à¸š" à¸—à¸µà¹ˆà¹€à¸£à¸²à¹€à¸­à¸²à¸¡à¸²à¸›à¸£à¸±à¸šà¹ƒà¸Šà¹‰à¸™à¸°! ---

    // 1. à¸¢à¸²à¸¡à¹€à¸Šà¹‡à¸„ "à¸šà¸±à¸•à¸£à¸žà¸™à¸±à¸à¸‡à¸²à¸™" (Cookie)
    //    à¸žà¸µà¹ˆà¸‚à¹‰à¸²à¸§à¸‚à¸­à¸­à¸˜à¸´à¸šà¸²à¸¢à¹€à¸£à¸·à¹ˆà¸­à¸‡ cookies() à¸­à¸µà¸à¸—à¸µà¸™à¸°! à¹€à¸£à¸²à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¹ƒà¸Šà¹‰ await à¸™à¸°à¹€à¸«à¸¡à¸µà¸¢à¸§ ðŸ±
      const cookie =  await cookies() 
    const userIdCookie = cookie.get('userId')
    if (!userIdCookie) {
      // à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µà¸šà¸±à¸•à¸£ à¸à¹‡ "à¸›à¸à¸´à¹€à¸ªà¸˜à¸à¸²à¸£à¹€à¸‚à¹‰à¸²" à¸”à¹‰à¸§à¸¢à¸ªà¸–à¸²à¸™à¸° 401
      return NextResponse.json({ error: "à¸à¸£à¸¸à¸“à¸²à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¸à¹ˆà¸­à¸™" }, { status: 401 }); // 401 = Unauthorized
    }
    const loggedInUserId = Number(userIdCookie.value);

    // 2. à¸¢à¸²à¸¡à¸„à¹‰à¸™à¸«à¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸šà¸—à¸„à¸§à¸²à¸¡à¹ƒà¸™ "à¹à¸Ÿà¹‰à¸¡à¹€à¸­à¸à¸ªà¸²à¸£" (Database)
    const article = await prisma.articleDB.findUnique({
      where: { id: articleId },
    });

    // 3. à¸–à¹‰à¸²à¸«à¸²à¹„à¸¡à¹ˆà¹€à¸ˆà¸­ à¸à¹‡à¸•à¸°à¹‚à¸à¸™à¸šà¸­à¸à¸§à¹ˆà¸² "404 à¸«à¸²à¹„à¸¡à¹ˆà¹€à¸ˆà¸­!"
    if (!article) {
      return NextResponse.json({ error: "à¹„à¸¡à¹ˆà¸žà¸šà¸šà¸—à¸„à¸§à¸²à¸¡à¸™à¸µà¹‰" }, { status: 404 }); // 404 = Not Found
    }

    // 4. à¸¢à¸²à¸¡à¹€à¸Šà¹‡à¸„à¸§à¹ˆà¸² "à¹€à¸›à¹‡à¸™à¹€à¸ˆà¹‰à¸²à¸‚à¸­à¸‡à¸šà¸—à¸„à¸§à¸²à¸¡à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ"
    if (article.userId !== loggedInUserId) {
      // à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ à¸à¹‡à¸•à¸°à¹‚à¸à¸™à¸šà¸­à¸à¸§à¹ˆà¸² "403 à¹„à¸¡à¹ˆà¸¡à¸µà¸ªà¸´à¸—à¸˜à¸´à¹Œà¹€à¸‚à¹‰à¸²!"
      return NextResponse.json({ error: "à¸„à¸¸à¸“à¹„à¸¡à¹ˆà¸¡à¸µà¸ªà¸´à¸—à¸˜à¸´à¹Œà¹à¸à¹‰à¹„à¸‚à¸šà¸—à¸„à¸§à¸²à¸¡à¸™à¸µà¹‰" }, { status: 403 }); // 403 = Forbidden
    }

    // --- à¸ˆà¸š Logic à¸ˆà¸²à¸ "à¸™à¸±à¸à¸ªà¸·à¸š" ---
    
    // 5. à¸–à¹‰à¸²à¸—à¸¸à¸à¸­à¸¢à¹ˆà¸²à¸‡à¸œà¹ˆà¸²à¸™à¸‰à¸¥à¸¸à¸¢ à¸à¹‡ "à¹€à¸›à¸´à¸”à¸›à¸£à¸°à¸•à¸¹" à¹à¸¥à¹‰à¸§à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸šà¸—à¸„à¸§à¸²à¸¡à¸à¸¥à¸±à¸šà¹„à¸›
    return NextResponse.json(article);

  } catch (error) {
    console.error("à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™ API:", error);
    return NextResponse.json({ error: "à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¸ à¸²à¸¢à¹ƒà¸™à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ" }, { status: 500 });
  }
}

